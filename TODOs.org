#+TITLE: Hammerspoon Config TODOs
#+STARTUP: overview
#+PROPERTY: cookie-data recursive
#+TAGS: feature refactor doc architecture perf tooling

* Vision
A data-oriented configuration system for Hammerspoon automation.

Users configure their automation using clear, composable concepts:
- *Event Sources* - things that emit events (file watchers, app monitors, USB listeners)
- *Events* - named occurrences with structured data
- *Behaviors* - named handlers that respond to events
- *Subscriptions* - connections between sources, events, and behaviors with filtering
- *Tags* - contextual labels for filtering (:work, :personal, :quiet-hours)
- *Components* - higher-level bundles of config+state+sources+behaviors

The system should be:
- *Declarative* - configuration as data, not imperative code
- *Visualizable* - can see what's configured and what's happening
- *Debuggable* - can trace why something did or didn't trigger
- *Queryable* - can inspect state (via SQLite, REPL, UI)

* Projects
** PROJ Configuration as Data [3/14]
Users define automations declaratively using data structures, not procedural code.
Can serialize, validate, and inspect the entire config.

*** Milestone 1: Multiple Instances of the Same Source Type [2/2]
User can create multiple instances of the same event-source type (e.g., two file-watchers watching different directories), each with its own config.

**** DONE Separate event-source class/instance concepts               :refactor:

**** DONE Event-sources can specify what they can emit :feature:

*** Milestone 2: Serializable Config [1/4]
Entire automation config can be represented as a single data structure, serialized to a file, and loaded back.

**** NOW Migrate registry/global APIs to datastructure/local APIs :architecture:
     - [X] event-registry (lib/event-registry.fnl)
     - [ ] behaviors-register (lib/behavior-registry.fnl)
     - [ ] subscriptions-register (lib/subscription-registry.fnl)
     - [ ] subscriptions-index (lib/subscription-registry.fnl)
     - [X] source-types-register (lib/source-registry.fnl)
     - [X] source-instances-register (lib/source-registry.fnl)

**** DONE Expand subscription data model :architecture:
     - name: unique identifier for the subscription
     - description: human-readable description
     - behavior: which behavior to invoke
     - event-selector: which events to match (event-name or event-kind)
     - source-selector: which event sources to match
     - require-tags: all tags that must exist on the event-source (placeholder for Contextual Automation)
     - exclude-tags: tags that must NOT exist on the event-source (placeholder for Contextual Automation)
     - Renamed subscribe -> define-subscription, unsubscribe -> remove-subscription
     - Added strict validation (errors on missing behavior/source/event-selector)
     - Moved get-subscribed-behaviors from dispatcher to subscription-registry

**** NEXT Refactor rest of the code to use the event/behavior pattern :refactor:

**** LATER [#C] Explore Clojure Integrant for data-driven config inspiration :architecture:
     - https://github.com/weavejester/integrant
     - component, mount, arachne, duct, etc

*** Milestone 3: Rich Subscription Matching [0/3]
Subscriptions can match events using flexible criteria - multiple event types, hierarchical matching, timing controls.

**** LATER [#B] Consider accepting a set of event-selectors for more flexibility :feature:
     - Currently subscribe-behavior takes a single event-selector
     - Could allow subscribing to multiple event-selectors at once

**** LATER [#C] Add debounce/throttle/delay to subscriptions          :feature:
     - Allow subscriptions to specify timing behavior
     - Useful for high-frequency events like file watchers

**** LATER [#C] Event-hierarchies have schemas that inherit to children :architecture:
     - Event-kinds define schemas
     - Child events inherit and extend parent schemas

*** Milestone 4: Components as First-Class Units [0/2]
User can define a "component" that bundles sources, behaviors, subscriptions, config, and state into a reusable unit.

**** LATER [#C] Define component concept                              :architecture:
     - Has config and state
     - Can be queried for config/state
     - Has event-sources and commands
     - event-source+config+state+commands+presentation

**** LATER [#C] Think of behavior dependency/priority/ordering strategies :architecture:
     - Define execution order when multiple behaviors match
     - Handle dependencies between behaviors

*** Milestone 5: Optimized & Documented [0/3]
System is performant and has comprehensive documentation for users.

**** LATER [#C] Cache ancestor lookups                                :perf:
     - Currently recalculated each time
     - Invalidate cache on derive/underive

**** LATER [#C] Create a tutorial-style doc for the event/behavior pattern :doc:

**** LATER [#C] Create doc explaining 4 orthogonal concepts           :doc:
     - Event-source, Event, Behavior, Subscription
     - How they are independent but compose together

** PROJ Visibility & Debugging [0/6]
Users can see what's configured, what's happening, and why.
Full interactive UI with controls, SQLite persistence, event tracing.

*** LATER [#A] Event-sources can be muted                             :feature:

*** LATER [#B] Validate schemas in debug mode                         :tooling:

*** LATER [#C] Create a UI to see the events/behaviors/subscriptions  :tooling:

*** LATER [#C] Add actions to the UI and more debugging tools         :tooling:

*** LATER [#C] Create a tool to export hierarchies into Graphviz      :tooling:

*** LATER [#C] Persist state into SQLite                              :tooling:
    - Save events, behaviors, subscriptions, hierarchy

** PROJ Contextual Automation [0/3]
Users can make automations context-aware using tags and filtering.
Enables modes, contexts, and conditional behavior.

*** LATER [#A] Define tag attachment to behavior/event-source-instance :architecture:

*** LATER [#B] Disable events, behaviors, subscriptions, tags, sources :feature:
    - Add ability to pause/disable at various levels
    - Could be global or per-subscription

*** LATER [#B] Implement require-tags/exclude-tags filtering in subscriptions :feature:
    - Builds on subscription data model from Configuration as Data project
    - Filter subscriptions based on event-source tags

** PROJ Expand Configuration Options [0/10]
Users can automate based on more system events.

*** LATER [#A] Create WiFi event source                               :feature:
    - Emit events on WiFi network change

*** LATER [#A] Create USB event source                                :feature:
    - Emit events on USB device attach/detach

*** LATER [#A] Create App event source                                :feature:
    - Emit events on app launch/quit/activate/deactivate/hidden

*** LATER [#A] Create Window event source                             :feature:
    - Emit events on window create/destroy/focus/unfocus/move/resize

*** LATER [#B] Create System event source                             :feature:
    - Emit events on wake/sleep/screens-changed/session-lock

*** LATER [#B] Create Hotkey event source                             :feature:
    - Emit events on hotkey press

*** LATER [#B] Create Screen event source                             :feature:
    - Emit events on display add/remove/layout-change

*** LATER [#C] Create Space event source                              :feature:
    - Emit events on space/desktop change

*** LATER [#C] Create Battery event source                            :feature:
    - Emit events on battery level/charging state change

*** LATER [#C] Add user commands, key mappings, etc on top of event/behavior system :architecture:

* Chores
*** LATER [#C] cliInstall doesn't work due to privileges              :tooling:
    - For now linked manually
    - Need to investigate proper permission handling for hs.ipc.cliInstall

*** LATER [#C] Proper shortcut and configs for expose                 :feature:
    - Current expose shortcut is ctrl-cmd-e
    - Need configurable shortcuts

*** LATER [#C] Make thumbnail height advisable when #102 lands        :feature:
    - Related to GitHub issue #102
    - Thumbnail height calculation should be configurable/advisable

* Archived
** DONE derive should check for cycles                                :feature:
    - Prevent A derives B derives A situations
    - Uses isa? to detect if parent already derives from child

** DONE Make hierarchies non-global                                   :architecture:
    - Create make-hierarchy function
    - Allow multiple independent hierarchies

** DONE Define all events in one file with proper domain-based event-kinds :refactor:

** DONE Separate subscription into its own module                     :refactor:

** DONE Rename functions to define-event/behavior/etc                 :refactor:

** DONE Rename registry maps to *-register                            :refactor:

** DONE Validate dependencies when defining things                    :feature:
    - When behavior definition mentions event-names, validate they exist
    - Warns (not errors) if dependencies are missing (due to load order)
